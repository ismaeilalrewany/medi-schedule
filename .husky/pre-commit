#!/bin/sh
echo "üîç Running pre-commit checks..."

# Test commands
# npm test
# cd frontend && npm test
# cd backend && npm test

echo "üìù Checking frontend linting..."
cd frontend && npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå Frontend linting failed"
  exit 1
fi
echo "‚úÖ Frontend linting passed"

echo "üî® Validating frontend build..."
cd frontend && npm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Frontend build failed"
  exit 1
fi
echo "‚úÖ Frontend build successful"

echo "üîç Validating backend startup..."
cd ../backend
# Check if backend can start without errors (quick validation)
timeout 10s npm start > /dev/null 2>&1 &
START_PID=$!
sleep 3
if kill -0 $START_PID 2>/dev/null; then
  echo "‚úÖ Backend starts successfully"
  kill $START_PID 2>/dev/null
else
  echo "‚ùå Backend failed to start"
  exit 1
fi

echo "üîç Checking documentation..."
cd ..
# Check if README exists and has content
if [ ! -f "README.md" ] || [ ! -s "README.md" ]; then
  echo "‚ùå README.md is missing or empty"
  exit 1
fi

# Check if CHANGELOG exists (should be created by semantic-release)
if [ ! -f "docs/CHANGELOG.md" ]; then
  echo "‚ö†Ô∏è Warning: CHANGELOG.md not found (will be created by semantic-release)"
fi

# Check for TODO or FIXME comments in code
echo "üîç Checking for unresolved TODOs/FIXMEs..."
TODO_COUNT=$(find frontend/src backend -name "*.js" -o -name "*.jsx" | xargs grep -l "TODO\|FIXME" | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "‚ö†Ô∏è Warning: Found $TODO_COUNT files with TODO/FIXME comments"
  find frontend/src backend -name "*.js" -o -name "*.jsx" | xargs grep -n "TODO\|FIXME" | head -5
  echo "Consider resolving these before committing to main/production"
fi

echo "‚úÖ Documentation checks completed"

echo "üöÄ All pre-commit checks passed!"
